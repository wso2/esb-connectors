<?xml version="1.0" encoding="UTF-8"?>
<template name="queryMore" xmlns="http://ws.apache.org/ns/synapse">
    <parameter name="batchSize"/>
    <sequence>
        <property
                expression="get-property('operation','salesforce.serviceUrl')" name="uri.var.salesforce.url"/>

        <payloadFactory>
            <format>
                <soapenv:Envelope
                        xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:partner.soap.sforce.com">
                    <soapenv:Header>
                        <urn:QueryOptions>
                            <urn:batchSize>$1</urn:batchSize>
                        </urn:QueryOptions>
                        <urn:SessionHeader>
                            <urn:sessionId>$2</urn:sessionId>
                        </urn:SessionHeader>
                    </soapenv:Header>
                    <soapenv:Body>
                        <urn:queryMore>
                            <urn:queryLocator>$3</urn:queryLocator>
                        </urn:queryMore>
                    </soapenv:Body>
                </soapenv:Envelope>
            </format>
            <args>
                <arg expression="get-property('batchSize1')"/>
                <arg expression="get-property('operation','salesforce.sessionId')"/>
                <arg expression="get-property('salesforce.query.queryLocator')"/>
            </args>
        </payloadFactory>

        <property name="messageType" scope="axis2" value="text/xml" />
        <header name="Action"
                value="urn:partner.soap.sforce.com/Soap/queryMoreRequest" />

        <property value="true" name="FORCE_ERROR_ON_SOAP_FAULT" />
        <property name="HTTP_METHOD" scope="axis2" value="POST" />
        <header name="To" expression="$ctx:uri.var.salesforce.url" />
        <call>
            <endpoint>
                <default format="soap11">
                    <timeout>
                        <duration>60000</duration>
                        <responseAction>fault</responseAction>
                    </timeout>
                    <suspendOnFailure>
                        <initialDuration>2000</initialDuration>
                        <progressionFactor>1.0</progressionFactor>
                        <maximumDuration>3000</maximumDuration>
                    </suspendOnFailure>
                </default>
            </endpoint>
        </call>


        <property expression="//ns:result/ns:done/text()"
                  name="salesforce.query.done" scope="default" type="STRING" xmlns:ns="urn:partner.soap.sforce.com"/>
        <property expression="//ns:result/ns:queryLocator/text()"
                  name="salesforce.query.queryLocator" scope="default"
                  type="STRING" xmlns:ns="urn:partner.soap.sforce.com"/>

        <property xmlns:sfp="urn:partner.soap.sforce.com" xmlns:sfo="urn:sobject.partner.soap.sforce.com"
                  xmlns:ns="http://org.apache.synapse/xsd" name="resultsCount" expression="//sfp:records"/>

        <property name="RESULTS" expression="fn:concat(get-property('RESULTS'),get-property('resultsCount'))"/>

        <filter xpath="(not(get-property('salesforce.query.queryLocator') = '' or (not(string(get-property('salesforce.query.queryLocator'))))))'">
            <then>
                <salesforce.queryMore/>
            </then>
            <else>
                <payloadFactory>
                    <format>
                        <soapenv:Envelope
                                xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                            <soapenv:Body>
                                <results>$1</results>
                            </soapenv:Body>
                        </soapenv:Envelope>
                    </format>
                    <args>
                        <arg expression="get-property('RESULTS')"/>
                    </args>
                </payloadFactory>
            </else>
        </filter>
    </sequence>
</template>