<?xml version="1.0" encoding="UTF-8"?>
<!-- This template sends emails and/or text messages to recipients. -->
<template xmlns="http://ws.apache.org/ns/synapse" name="sendNotifications">

	<!-- Gmail parameters -->
	<parameter name="gmail.username" description="Gmail user name to login to the user account." />
	<parameter name="gmail.oAuthAccessToken" description="OAuth access Token to access the Gmail API through the App." />	 
	<parameter name="gmail.subject" description="(Optional) Subject of the e-mail message." />
	<parameter name="gmail.toRecipients" description="A comma seperated list of recipients." />
	<parameter name="gmail.ccRecipients" description="A comma seperated list of cc recipients." />
	<parameter name="gmail.bccRecipients" description="A comma seperated list of bcc recipients." />
	<parameter name="gmail.textContent" description="(Optional) Text content of the mail." />
	<parameter name="gmail.responseIds" description="FreshDesk ticket details." />
	
    <sequence>
        <!-- Gmail properties -->
		<property name="uri.var.gmail.username" expression="$func:gmail.username"/>
        <property name="uri.var.gmail.oAuthAccessToken" expression="$func:gmail.oAuthAccessToken"/>
        <property name="uri.var.gmail.subject" expression="$func:gmail.subject" />
        <property name="uri.var.gmail.toRecipients" expression="$func:gmail.toRecipients" />
        <property name="uri.var.gmail.ccRecipients" expression="$func:gmail.ccRecipients" />
        <property name="uri.var.gmail.bccRecipients" expression="$func:gmail.bccRecipients" />
        <property name="uri.var.gmail.textContent" expression="$func:gmail.textContent" />
		<property name="uri.var.gmail.responseIds" expression="$func:gmail.responseIds" />

        <!-- Send a mail through Gmail - Executed only if both username and oAuthAccessToken of Gmail is sent.-->
        <filter xpath="boolean(get-property('uri.var.gmail.username')) and boolean(get-property('uri.var.gmail.oAuthAccessToken'))">
            <then>
				<!-- Send mail through Gmail.-->
                <gmail.init>
					<username>{$ctx:uri.var.gmail.username}</username>
					<oauthAccessToken>{$ctx:uri.var.gmail.oAuthAccessToken}</oauthAccessToken>
				</gmail.init>
				<gmail.sendMail>
					<subject>{$ctx:uri.var.gmail.subject}</subject>
					<toRecipients>{$ctx:uri.var.gmail.toRecipients}</toRecipients>
					<ccRecipients>{$ctx:uri.var.gmail.ccRecipients}</ccRecipients>
					<bccRecipients>{$ctx:uri.var.gmail.bccRecipients}</bccRecipients>
					<textContent>{$ctx:uri.var.gmail.textContent}</textContent>
				</gmail.sendMail>
				
				<!-- Removing unused headers by calling a sequence template -->
				<sequence key="removeResponseHeaders" />
				
                <!--Extract the recipients.-->
                <property name="uri.var.gmail.responseRecipients" expression="json-eval($.sendMailResponse.message.recipients)" />
				<property name="uri.var.gmail.id" expression="get-property('uri.var.gmail.responseIds')" />
				
                <!--If emails are sent to recipients successfully through Gmail, send a success message to user. Else send an error message with the API error response.-->
                <filter source="boolean(get-property('uri.var.gmail.responseRecipients'))" regex="true">
                    <then>
                        <property name="uri.var.gmail.status" value="Success" />
                        <property name="uri.var.gmail.message" expression="fn:concat('An email has been sent to - ', get-property('uri.var.gmail.responseRecipients'), ' by Gmail.')" />
                    </then>
                    <else>
                        <property name="uri.var.gmail.status" value="Error" />
                        <property name="uri.var.gmail.message" expression="json-eval($)" />
                    </else>
                </filter>
				
                <!--Call the responseHandler template-->
                <property name="uri.var.activity" value="gmail_sendEmailsToRecipients" />
                <call-template target="responseHandlerTemplate">
                    <with-param name="activity" value="{$ctx:uri.var.activity}" />
                    <with-param name="id" value="{$ctx:uri.var.gmail.id}" />
                    <with-param name="status" value="{$ctx:uri.var.gmail.status}" />
                    <with-param name="message" value="{$ctx:uri.var.gmail.message}" />
                </call-template>
				
				<property name="uri.var.gmail.username" expression="$func:gmail.username" action="remove" />
				<property name="uri.var.gmail.oAuthAccessToken" expression="$func:gmail.oAuthAccessToken" action="remove" />
            </then>
        </filter>
    </sequence>
</template>