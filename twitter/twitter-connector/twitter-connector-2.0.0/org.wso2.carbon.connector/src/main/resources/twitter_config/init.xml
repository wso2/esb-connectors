<?xml version="1.0" encoding="utf-8"?>
<!--
 ~ Copyright (c) 2014-2015, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 ~
 ~ Licensed under the Apache License, Version 2.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~
 ~      http://www.apache.org/licenses/LICENSE-2.0
 ~
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
-->

<template xmlns="http://ws.apache.org/ns/synapse" name="init">
    <parameter name="consumerKey" />
    <parameter name="consumerSecret" />
    <parameter name="accessToken" />
    <parameter name="accessTokenSecret" />
    <parameter name="apiUrl" />
    <sequence>
        <property name="uri.var.apiUrl" expression="$func:apiUrl" />

        <!-- If the apiUrl is not specified, set the default value as https://simple-note.appspot.com -->
        <filter source="boolean(get-property('uri.var.apiUrl'))" regex="true">
            <then>
                <property name="uri.var.apiUrl" expression="fn:concat(get-property('uri.var.apiUrl'), '/1.1')" />
            </then>
            <else>
                <property name="uri.var.apiUrl" value="https://api.twitter.com" />
            </else>
        </filter>

        <property expression="$func:consumerKey" name="twitter.consumerKey"
                  type="STRING" />
        <property expression="$func:consumerSecret" name="twitter.consumerSecret"
                  type="STRING" />

        <property name="twitter.basekey"
                  expression="fn:concat(get-property('twitter.consumerKey'),':',get-property('twitter.consumerSecret'))" />

        <property name="Authorization"
                  expression="fn:concat('Basic ', base64Encode(get-property('twitter.basekey')))"
                  scope="transport" />

        <property name="DISABLE_CHUNKING" value="true" scope="axis2" />

        <payloadFactory>
            <format>
                <POST>
                    <grant_type>client_credentials</grant_type>
                </POST>
            </format>
            <args />
        </payloadFactory>

        <property name="messageType" value="application/x-www-form-urlencoded"
                  scope="axis2" />
        <property expression="$func:apiUrl" name="twitter.apiUrl"
                  type="STRING" />

        <call>
            <endpoint>
                <http method="POST" uri-template="https://api.twitter.com/oauth2/token" />
            </endpoint>
        </call>
        <property name="twitter.accessToken" expression="//access_token"
                  type="STRING" />

        <property name="Authorization"
                  expression="fn:concat('Bearer ', get-property('twitter.accessToken'))"
                  scope="transport" />

        <!-- Remove custom header information in response -->
        <header name="X-Runtime" scope="transport" action="remove" />
        <header name="X-Rate-Limit-Limit" scope="transport" action="remove" />
        <header name="X-Rate-Limit-Remaining" scope="transport" action="remove" />
        <header name="X-Request-Id" scope="transport" action="remove" />
        <header name="X-Content-Type-Options" scope="transport" action="remove" />
        <header name="X-Xss-Protection" scope="transport" action="remove" />
        <header name="X-Frame-Options" scope="transport" action="remove" />
        <header name="X-Rate-Limit-Reset" scope="transport" action="remove" />
        <header name="X-Pagination" scope="transport" action="remove" />
        <header name="Link" scope="transport" action="remove" />
        <header name="Cache-Control" scope="transport" action="remove" />
        <header name="Pragma" scope="transport" action="remove" />
        <header name="Www-Authenticate" scope="transport" action="remove" />
        <header name="Proxy-Support" scope="transport" action="remove" />

    </sequence>
</template>